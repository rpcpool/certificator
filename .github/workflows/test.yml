name: Test

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  test:
    name: Lint and Test
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@e50d5f73bfe71c2dd0aa4218de8f4afe1f168571 # v16

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@87b14cf437d03d37989d87f0fa5ce4f5dc1a330b # v8

      - name: Install devenv
        run: nix profile install nixpkgs#devenv

      - name: Run Linting
        run: |
          devenv shell bash -- -c '
            echo "=== Running gofmt ==="
            gofmt -l -d . | tee /tmp/gofmt.out
            if [ -s /tmp/gofmt.out ]; then
              echo "gofmt found formatting issues"
              exit 1
            fi

            echo "=== Running goimports ==="
            goimports -l -d . | tee /tmp/goimports.out
            if [ -s /tmp/goimports.out ]; then
              echo "goimports found issues"
              exit 1
            fi

            echo "=== Running go vet ==="
            go vet ./...

            echo "=== Running golangci-lint ==="
            golangci-lint run ./...
          '

      - name: Run Unit Tests
        run: |
          devenv shell bash -- -c '
            echo "=== Running unit tests ==="
            go test -v -race ./...
          '

      - name: Run Integration Tests
        run: |
          devenv shell bash -- -c '
            echo "=== Running integration tests ==="
            ./test/integration/run-tests.sh
          '

      - name: Build Binaries
        run: |
          devenv shell bash -- -c '
            echo "=== Building binaries ==="
            go build -o certificator ./cmd/certificator
            go build -o certificatee ./cmd/certificatee
            echo "Build complete!"
          '
